ğŸ“‹ COMPLETE BACKUP SYSTEM DESCRIPTION - SimTree Production Database
ğŸ¯ SYSTEM OVERVIEW
This is an automated, cloud-based backup system for SimTree's production PostgreSQL database (hosted on Neon). The system runs independently on GitHub Actions (24/7 availability) and does NOT depend on the Replit application being online.

ğŸ—ï¸ SYSTEM ARCHITECTURE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub Actions (Executor)                    â”‚
â”‚  - Runs on Ubuntu 24.04 LTS                                     â”‚
â”‚  - Executes on schedule (cron) or manual trigger                â”‚
â”‚  - PostgreSQL 17 client installed                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â–º Connects to Neon PostgreSQL 17.7 (Production DB)
             â”‚   - Executes pg_dump to extract database
             â”‚   - Compresses with gzip (level 9)
             â”‚
             â”œâ”€â–º Uploads to Google Drive (3 separate folders)
             â”‚   - Uses Service Account authentication
             â”‚   - Streams data directly (no local disk storage)
             â”‚
             â””â”€â–º Sends notifications via SendGrid
                 - Weekly summary (Fridays)
                 - Failure alerts (after 3 failed attempts)

ğŸ“¦ BACKUP TYPES & SCHEDULE
1. DAILY FULL BACKUP

Frequency: Every day at 3:00 AM Argentina Time (6:00 AM UTC)
Scope: Complete database dump (all tables, all data)
Retention: 30 backups (1 month)
Folder: daily-db-backups (ID: 1MGgU3_IlZUmlBCB2bf7DWdSSp-304nrT)
File naming: simtree-daily-backup-YYYYMMDD-HHMMSS.sql.gz

2. MONTHLY FULL BACKUP

Frequency: 1st day of each month at 5:00 AM Argentina Time (8:00 AM UTC)
Scope: Complete database dump (all tables, all data)
Retention: 12 backups (1 year)
Folder: monthly-backups (ID: 1EjGC5dRoGHquDz8DJ0KGfPMrWyv6HtRS)
File naming: simtree-monthly-backup-YYYYMMDD-HHMMSS.sql.gz

3. HOURLY INCREMENTAL BACKUP (Critical tables only)

Frequency: Every hour on the hour (24 times per day)
Scope: ONLY 3 critical tables:

wallets (user wallets)
wallet_transactions (transaction history)
purchased_esims (purchased eSIM records)


Retention: 48 backups (2 days)
Folder: hourly-diffs (ID: 1RiEv6y06PDeGVP1gFVEz6uc6m2n6fSqU)
File naming: simtree-hourly-backup-YYYYMMDD-HHMMSS.sql.gz

4. WEEKLY SUMMARY REPORT

Frequency: Every Friday at 5:00 PM Argentina Time (8:00 PM UTC)
Action: Sends email summary with statistics
Content: Total backups created, storage used, success status
No files created - only email report


ğŸ”„ BACKUP EXECUTION FLOW
Step-by-Step Process:

TRIGGER

GitHub Actions cron scheduler activates at configured time
OR manual trigger from GitHub UI


ENVIRONMENT SETUP

Checkout repository code
Install Node.js 20
Install PostgreSQL 17 client
Install npm dependencies (googleapis, sendgrid, google-auth-library)


DATABASE DUMP

bash   # For full backups (daily/monthly):
   pg_dump "postgresql://..." --no-owner --no-acl | gzip -9
   
   # For hourly backups (critical tables only):
   pg_dump "postgresql://..." --no-owner --no-acl \
     -t wallets -t wallet_transactions -t purchased_esims | gzip -9
```

4. **RETRY MECHANISM** (if dump fails)
   - Attempt 1 â†’ Wait 1 second â†’ Attempt 2 â†’ Wait 2 seconds â†’ Attempt 3
   - Exponential backoff between retries
   - Maximum 3 attempts per backup

5. **UPLOAD TO GOOGLE DRIVE**
   - Authenticate using Service Account JSON
   - Stream compressed file directly to Google Drive
   - No intermediate disk storage (memory streaming)
   - File ID returned for tracking

6. **RETENTION MANAGEMENT**
   - List all files in target folder
   - Sort by creation date (newest first)
   - Delete oldest files exceeding retention limit:
     - Daily: Keep 30, delete rest
     - Monthly: Keep 12, delete rest
     - Hourly: Keep 48, delete rest

7. **NOTIFICATION** (Conditional)
   - **Success:** No individual email (only weekly summary)
   - **Failure (after 3 attempts):** Send urgent email with error details

---

## ğŸ” AUTHENTICATION & SECURITY

### Google Drive Access
- **Method:** Service Account (OAuth 2.0)
- **Email:** `simtree-backup-service@[project-id].iam.gserviceaccount.com`
- **Permissions:** Editor role on 3 specific folders
- **Storage:** Credentials stored as GitHub Secret (encrypted)

### Database Connection
- **Method:** PostgreSQL connection string with SSL
- **Format:** `postgresql://user:pass@host/db?sslmode=require`
- **Storage:** GitHub Secret `PROD_DATABASE_URL`

### Email Notifications
- **Provider:** SendGrid
- **Authentication:** API Key
- **From:** `hey@simtree.co` (or configured email)
- **To:** `yateshaw@gmail.com`

---

## ğŸ“Š DATA FLOW DIAGRAM
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub      â”‚
â”‚  Actions     â”‚
â”‚  (Scheduler) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backup Script Execution             â”‚
â”‚  (scripts/github-actions-backup.ts)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–º Connect to Neon PostgreSQL
       â”‚   â”œâ”€ Execute pg_dump
       â”‚   â””â”€ Compress with gzip
       â”‚
       â”œâ”€â–º Authenticate to Google Drive
       â”‚   â”œâ”€ Parse Service Account JSON
       â”‚   â””â”€ Obtain OAuth token
       â”‚
       â”œâ”€â–º Upload Backup File
       â”‚   â”œâ”€ Create file in Drive folder
       â”‚   â”œâ”€ Stream data (no local storage)
       â”‚   â””â”€ Return file ID
       â”‚
       â”œâ”€â–º Manage Retention
       â”‚   â”œâ”€ List existing files
       â”‚   â”œâ”€ Sort by date
       â”‚   â””â”€ Delete oldest files
       â”‚
       â””â”€â–º Send Notification (if needed)
           â””â”€ Email via SendGrid

ğŸ”§ TECHNICAL SPECIFICATIONS
PostgreSQL Dump Options

--no-owner - Don't restore object ownership
--no-acl - Don't restore access privileges
-t [table] - Dump specific table only (hourly backups)

Compression

Algorithm: gzip
Level: 9 (maximum compression)
Typical ratio: ~10:1 (10 MB â†’ 1 MB)

File Streaming

Method: Node.js Readable streams
Benefits:

No disk I/O on GitHub Actions runner
Lower memory footprint
Faster upload times
No temporary file cleanup needed



Google Drive API

Version: v3
Operations:

files.create - Upload new backup
files.list - Get existing backups
files.delete - Remove old backups


Authentication: OAuth 2.0 with Service Account


ğŸ“ FILE STRUCTURE
typescript// Main backup script structure
interface BackupConfig {
  type: 'daily' | 'monthly' | 'hourly';
  databaseUrl: string;           // Neon connection string
  folderId: string;              // Google Drive folder ID
  maxRetention: number;          // Number of backups to keep
}

interface BackupResult {
  success: boolean;
  filename?: string;             // Backup file name
  size?: number;                 // File size in bytes
  fileId?: string;               // Google Drive file ID
  error?: string;                // Error message if failed
  attempt?: number;              // Attempt number (1-3)
}
```

---

## ğŸš¨ ERROR HANDLING

### Retry Logic
```
Attempt 1 FAILS
  â†“
Wait 1 second (2^0 * 1000ms)
  â†“
Attempt 2 FAILS
  â†“
Wait 2 seconds (2^1 * 1000ms)
  â†“
Attempt 3 FAILS
  â†“
Send failure email
Exit with error
Common Errors & Recovery
ErrorCauseAuto-RecoveryConnection timeoutNetwork issueâœ… Retry handles itInvalid JWT SignatureWrong service account JSONâŒ Needs manual fixFile not foundOld file already deletedâš ï¸ Non-critical, continuesVersion mismatchPostgreSQL version incompatibleâŒ Needs pg_dump update

ğŸ“§ NOTIFICATION SYSTEM
Weekly Summary Email (Fridays 5 PM)
Contains:

Total backups created in past 7 days per type
Storage consumed (GB)
Success/failure status
Retention configuration

Format: HTML email with statistics grid
Failure Alert Email (Immediate)
Sent when:

Backup fails after 3 retry attempts

Contains:

Backup type that failed
Number of attempts made
Detailed error message
Recommended actions


ğŸ›ï¸ MANUAL EXECUTION
Backups can be triggered manually from GitHub:

Navigate to repository â†’ Actions tab
Click Production Database Backups workflow
Click Run workflow button
Select backup type:

daily - Full database backup
monthly - Full database backup
hourly - Critical tables only
weekly-summary - Send email summary


Click Run workflow to execute


ğŸ“ˆ STORAGE ESTIMATES
Assuming:

Production database size: ~500 MB
Compression ratio: 10:1
Critical tables: ~50 MB (10% of total)

Monthly storage usage:

Daily backups: 30 Ã— 50 MB = 1.5 GB
Monthly backups: 12 Ã— 50 MB = 600 MB
Hourly backups: 48 Ã— 5 MB = 240 MB
Total: ~2.34 GB per month


ğŸ” MONITORING & LOGS
GitHub Actions Logs

Full execution trace available in Actions tab
Logs retained for 90 days
Downloadable for offline analysis

Database Tracking
The system logs each backup to a backups table:
sqlCREATE TABLE backups (
  id SERIAL PRIMARY KEY,
  filename TEXT,
  size BIGINT,
  drive_file_id TEXT,
  type TEXT,
  status TEXT,
  created_at TIMESTAMP
);

âš™ï¸ CONFIGURATION VARIABLES
GitHub Secrets (Required)

PROD_DATABASE_URL - Neon PostgreSQL connection string
GOOGLE_SERVICE_ACCOUNT_JSON - Full service account JSON
GOOGLE_DRIVE_FOLDER_ID_DAILY - Daily backup folder ID
GOOGLE_DRIVE_FOLDER_ID_MONTHLY - Monthly backup folder ID
GOOGLE_DRIVE_FOLDER_ID_HOURLY - Hourly backup folder ID
SENDGRID_API_KEY - SendGrid API key
SENDGRID_FROM_EMAIL - Sender email (optional)

Retention Limits (Hardcoded)
typescriptconst retentionMap = {
  daily: 30,     // 1 month
  monthly: 12,   // 1 year
  hourly: 48,    // 2 days
};

ğŸ†˜ DISASTER RECOVERY
How to Restore a Backup

Download backup from Google Drive

bash   # File will be named: simtree-[type]-backup-YYYYMMDD-HHMMSS.sql.gz

Decompress the file

bash   gunzip simtree-daily-backup-20241224-060000.sql.gz

Restore to database

bash   psql "postgresql://user:pass@host/db?sslmode=require" < simtree-daily-backup-20241224-060000.sql

Verify restoration

sql   SELECT COUNT(*) FROM wallets;
   SELECT COUNT(*) FROM purchased_esims;

ğŸš€ ADVANTAGES OF THIS SYSTEM

Independence: Runs on GitHub infrastructure, not dependent on Replit
Reliability: GitHub Actions has 99.95% uptime SLA
Cost: Free (GitHub Actions provides 2000 free minutes/month)
Security: Encrypted secrets, no credentials in code
Scalability: Can handle databases up to several GB
Visibility: Full logs and email notifications
Automation: Zero manual intervention required
Multi-tier: Different retention policies for different needs