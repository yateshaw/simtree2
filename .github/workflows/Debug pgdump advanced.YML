name: DEBUG - Test pg_dump Data Export
on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-24.04
    steps:
      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Critical Diagnostics
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          echo "=================================================="
          echo "ðŸ” ADVANCED pg_dump DIAGNOSTICS"
          echo "=================================================="
          echo ""
          
          echo "1ï¸âƒ£ Verify row counts in database:"
          psql "${DATABASE_URL}" -c "
            SELECT 
              'esim_plans' AS table_name,
              COUNT(*) AS rows
            FROM esim_plans
            UNION ALL
            SELECT 'connection_logs', COUNT(*) FROM connection_logs
            UNION ALL
            SELECT 'session', COUNT(*) FROM session
            UNION ALL
            SELECT 'wallet_transactions', COUNT(*) FROM wallet_transactions;
          "
          echo ""
          
          echo "2ï¸âƒ£ Check for Row Level Security policies:"
          psql "${DATABASE_URL}" -c "
            SELECT 
              schemaname,
              tablename,
              policyname,
              permissive,
              roles
            FROM pg_policies
            WHERE schemaname = 'public';
          "
          echo ""
          
          echo "3ï¸âƒ£ TEST A: Data-only dump of esim_plans (uncompressed):"
          pg_dump "${DATABASE_URL}" \
            --schema=public \
            --table=esim_plans \
            --data-only \
            --no-owner \
            --no-acl \
            > /tmp/test-data-only.sql
          
          DATA_SIZE=$(wc -c < /tmp/test-data-only.sql)
          DATA_LINES=$(wc -l < /tmp/test-data-only.sql)
          echo "  Size: $DATA_SIZE bytes ($(echo "scale=2; $DATA_SIZE / 1024" | bc) KB)"
          echo "  Lines: $DATA_LINES"
          echo "  First 50 lines:"
          head -50 /tmp/test-data-only.sql
          echo ""
          
          if [ $DATA_SIZE -lt 10000 ]; then
            echo "âŒ Data-only dump is EMPTY or very small!"
            echo "This confirms the issue is with data export, not structure."
          else
            echo "âœ… Data-only dump has content"
          fi
          echo ""
          
          echo "4ï¸âƒ£ TEST B: Full dump with COPY format (default):"
          pg_dump "${DATABASE_URL}" \
            --schema=public \
            --table=esim_plans \
            --no-owner \
            --no-acl \
            --verbose \
            2>&1 | tee /tmp/test-full-verbose.log > /tmp/test-full.sql
          
          FULL_SIZE=$(wc -c < /tmp/test-full.sql)
          echo "  Size: $FULL_SIZE bytes ($(echo "scale=2; $FULL_SIZE / 1024" | bc) KB)"
          echo ""
          echo "  Verbose log (last 30 lines):"
          tail -30 /tmp/test-full-verbose.log
          echo ""
          
          echo "5ï¸âƒ£ TEST C: Dump with INSERT statements instead of COPY:"
          pg_dump "${DATABASE_URL}" \
            --schema=public \
            --table=esim_plans \
            --data-only \
            --column-inserts \
            --no-owner \
            --no-acl \
            > /tmp/test-inserts.sql
          
          INSERT_SIZE=$(wc -c < /tmp/test-inserts.sql)
          INSERT_COUNT=$(grep -c "INSERT INTO" /tmp/test-inserts.sql || echo 0)
          echo "  Size: $INSERT_SIZE bytes ($(echo "scale=2; $INSERT_SIZE / 1024" | bc) KB)"
          echo "  INSERT statements found: $INSERT_COUNT"
          echo "  First INSERT:"
          grep "INSERT INTO" /tmp/test-inserts.sql | head -1 || echo "No INSERTs found"
          echo ""
          
          if [ $INSERT_COUNT -gt 0 ]; then
            echo "âœ… INSERT format works! Using this for backups."
          else
            echo "âŒ INSERT format also fails. Likely RLS or permissions issue."
          fi
          echo ""
          
          echo "6ï¸âƒ£ TEST D: Direct query test:"
          psql "${DATABASE_URL}" -c "SELECT * FROM esim_plans LIMIT 3;" || echo "âŒ Direct SELECT failed!"
          echo ""
          
          echo "7ï¸âƒ£ Check user's RLS bypass privilege:"
          psql "${DATABASE_URL}" -c "
            SELECT 
              r.rolname,
              r.rolsuper,
              r.rolcanlogin,
              r.rolbypassrls
            FROM pg_roles r
            WHERE r.rolname = current_user;
          "
          echo ""
          
          echo "=================================================="
          echo "ðŸ“Š SUMMARY"
          echo "=================================================="
          echo "Data-only size: $DATA_SIZE bytes"
          echo "Full dump size: $FULL_SIZE bytes"
          echo "INSERT format size: $INSERT_SIZE bytes"
          echo "INSERT count: $INSERT_COUNT"
          echo ""
          
          if [ $INSERT_COUNT -gt 2000 ]; then
            echo "âœ… SOLUTION: Use --column-inserts format"
            echo "This format successfully exports data."
          elif [ $DATA_SIZE -gt 100000 ]; then
            echo "âœ… SOLUTION: COPY format works"
            echo "The issue may be with compression or other flags."
          else
            echo "âŒ CRITICAL: Neither COPY nor INSERT formats work"
            echo "Likely causes:"
            echo "  1. Row Level Security is blocking export"
            echo "  2. User lacks SELECT permission (despite privileges showing otherwise)"
            echo "  3. Neon bug with pg_dump 17.7"
            echo ""
            echo "NEXT STEP: Contact Neon support with these diagnostics"
          fi
