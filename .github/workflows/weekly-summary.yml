name: Report - Weekly Summary
on:
  schedule:
    - cron: '0 20 * * 5'
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-24.04
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm install --no-save googleapis @sendgrid/mail
      - name: Send Report
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_DRIVE_FOLDER_ID_HOURLY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_HOURLY }}
          GOOGLE_DRIVE_FOLDER_ID_DAILY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_DAILY }}
          GOOGLE_DRIVE_FOLDER_ID_MONTHLY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_MONTHLY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          NOTIFICATION_EMAIL: ${{ secrets.BACKUP_NOTIFICATION_EMAIL }}
        run: |
          cat > report.mjs << 'EOF'
          import { google } from 'googleapis';
          import sgMail from '@sendgrid/mail';

          const { GOOGLE_SERVICE_ACCOUNT_JSON, SENDGRID_API_KEY, FROM_EMAIL, NOTIFICATION_EMAIL, GOOGLE_DRIVE_FOLDER_ID_HOURLY, GOOGLE_DRIVE_FOLDER_ID_DAILY, GOOGLE_DRIVE_FOLDER_ID_MONTHLY } = process.env;

          async function run() {
            const auth = new google.auth.GoogleAuth({ credentials: JSON.parse(GOOGLE_SERVICE_ACCOUNT_JSON), scopes: ['https://www.googleapis.com/auth/drive'] });
            const drive = google.drive({ version: 'v3', auth });
            const folders = [{ t: 'Daily', id: GOOGLE_DRIVE_FOLDER_ID_DAILY }, { t: 'Monthly', id: GOOGLE_DRIVE_FOLDER_ID_MONTHLY }, { t: 'Hourly', id: GOOGLE_DRIVE_FOLDER_ID_HOURLY }];
            const summary = [];

            for (const f of folders) {
              const res = await drive.files.list({ q: `'${f.id}' in parents and trashed=false`, fields: 'files(size)', supportsAllDrives: true, includeItemsFromAllDrives: true });
              const files = res.data.files || [];
              const size = (files.reduce((a, b) => a + parseInt(b.size || 0), 0) / 1024 / 1024).toFixed(2);
              summary.push({ type: f.t, count: files.length, size: `${size} MB` });
            }

            const html = `
            <div style="background-color: #1a1a1a; color: #ffffff; padding: 20px; font-family: sans-serif; border-radius: 8px;">
              <h2 style="color: #4caf50;">ðŸ“Š SimTree Weekly Backup Summary</h2>
              <table style="width: 100%; border-collapse: collapse; margin-top: 20px; color: #e0e0e0; background-color: #262626;">
                <thead>
                  <tr style="background-color: #333; text-align: left;">
                    <th style="padding: 10px; border: 1px solid #444;">Type</th>
                    <th style="padding: 10px; border: 1px solid #444;">Total Backups</th>
                    <th style="padding: 10px; border: 1px solid #444;">Storage Used</th>
                  </tr>
                </thead>
                <tbody>
                  ${summary.map(r => `<tr><td style="padding:10px;border:1px solid #444;">${r.type}</td><td style="padding:10px;border:1px solid #444;">${r.count}</td><td style="padding:10px;border:1px solid #444;">${r.size}</td></tr>`).join('')}
                </tbody>
              </table>
              <p style="margin-top: 20px;">System status: âœ… Operational</p>
            </div>`;

            sgMail.setApiKey(SENDGRID_API_KEY);
            await sgMail.send({ to: NOTIFICATION_EMAIL, from: FROM_EMAIL, subject: "SimTree Weekly Backup Summary", html });
          }
          run();
          EOF
          node report.mjs
