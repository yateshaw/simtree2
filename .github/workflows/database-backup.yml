name: Production Database Backups
on:
  schedule:
    - cron: '0 6 * * *'     # Diarios
    - cron: '0 8 1 * *'     # Mensuales
    - cron: '0 * * * *'     # Por hora
    - cron: '0 20 * * 5'    # Resumen semanal (Viernes)
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Tipo de backup'
        required: true
        default: 'daily'
        type: choice
        options: [daily, monthly, hourly, weekly-summary]

env:
  NODE_VERSION: '20'

jobs:
  backup:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
          echo "/usr/lib/postgresql/17/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: npm install --no-save googleapis @sendgrid/mail google-auth-library

      - name: Determine backup type
        id: backup-type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.backup_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 20 * * 5" ]; then
            echo "type=weekly-summary" >> $GITHUB_OUTPUT
          else
            echo "type=${{ github.event.inputs.backup_type || 'daily' }}" >> $GITHUB_OUTPUT
          fi

      - name: Create and Run Backup Script
        env:
          BACKUP_TYPE: ${{ steps.backup-type.outputs.type }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_DRIVE_FOLDER_ID_DAILY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_DAILY }}
          GOOGLE_DRIVE_FOLDER_ID_MONTHLY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_MONTHLY }}
          GOOGLE_DRIVE_FOLDER_ID_HOURLY: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_HOURLY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          BACKUP_NOTIFICATION_EMAIL: ${{ secrets.BACKUP_NOTIFICATION_EMAIL }}
        run: |
          cat > backup.mjs << 'EOF'
          import { google } from 'googleapis';
          import { exec } from 'child_process';
          import { createReadStream, statSync, unlinkSync, existsSync } from 'fs';
          import { promisify } from 'util';
          const execAsync = promisify(exec);

          const { BACKUP_TYPE, DATABASE_URL, GOOGLE_SERVICE_ACCOUNT_JSON, GOOGLE_DRIVE_FOLDER_ID_DAILY, GOOGLE_DRIVE_FOLDER_ID_MONTHLY, GOOGLE_DRIVE_FOLDER_ID_HOURLY, SENDGRID_API_KEY, NOTIFICATION_EMAIL, FROM_EMAIL } = process.env;

          async function sendEmail(subject, html) {
            console.log(`>>> Intentando enviar email: "${subject}" a ${NOTIFICATION_EMAIL}`);
            try {
              const res = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: { 
                  'Authorization': `Bearer ${SENDGRID_API_KEY}`, 
                  'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                  personalizations: [{ to: [{ email: NOTIFICATION_EMAIL }] }],
                  from: { email: FROM_EMAIL, name: 'SimTree Backup' },
                  subject: subject,
                  content: [{ type: 'text/html', value: html }]
                })
              });
              
              if (res.ok) {
                console.log(">>> ‚úÖ SendGrid acept√≥ el mensaje.");
              } else {
                const errBody = await res.text();
                console.error(`>>> ‚ùå Error de SendGrid (${res.status}):`, errBody);
              }
            } catch (e) {
              console.error(">>> ‚ùå Error fatal en fetch de email:", e.message);
            }
          }

          function getAuth() {
            return new google.auth.GoogleAuth({
              credentials: JSON.parse(GOOGLE_SERVICE_ACCOUNT_JSON),
              scopes: ['https://www.googleapis.com/auth/drive']
            });
          }

          async function getWeeklySummary() {
            console.log(">>> Generando resumen semanal...");
            const drive = google.drive({ version: 'v3', auth: getAuth() });
            const folders = [
              { name: 'Daily', id: GOOGLE_DRIVE_FOLDER_ID_DAILY, policy: '30 backups' },
              { name: 'Monthly', id: GOOGLE_DRIVE_FOLDER_ID_MONTHLY, policy: '12 backups' },
              { name: 'Hourly', id: GOOGLE_DRIVE_FOLDER_ID_HOURLY, policy: '48 backups' }
            ];

            let rows = "";
            let totalCount = 0;
            let totalSizeBytes = 0;
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);

            for (const folder of folders) {
              const res = await drive.files.list({
                q: `'${folder.id}' in parents and trashed=false`,
                fields: 'files(id, size, createdTime)',
                supportsAllDrives: true,
                includeItemsFromAllDrives: true
              });
              const files = res.data.files || [];
              const thisWeek = files.filter(f => new Date(f.createdTime) > weekAgo).length;
              const sizeFolderBytes = files.reduce((acc, f) => acc + parseInt(f.size || 0), 0);
              
              totalCount += thisWeek;
              totalSizeBytes += sizeFolderBytes;

              rows += `<tr>
                <td style="padding:8px; border:1px solid #444;">${folder.name}</td>
                <td style="padding:8px; border:1px solid #444;">${thisWeek}</td>
                <td style="padding:8px; border:1px solid #444;">${files.length}</td>
                <td style="padding:8px; border:1px solid #444;">${(sizeFolderBytes / (1024*1024)).toFixed(2)} MB</td>
                <td style="padding:8px; border:1px solid #444;">${folder.policy}</td>
              </tr>`;
            }

            return `
              <div style="font-family: sans-serif; background: #1a1a1a; color: #fff; padding: 20px;">
                <h2 style="color: #4caf50;">üìä SimTree Weekly Backup Summary</h2>
                <p>Report Date: ${new Date().toISOString()}</p>
                <table style="width:100%; border-collapse: collapse; text-align: left; background: #2d2d2d; color: #eee;">
                  <thead>
                    <tr style="background: #444;">
                      <th style="padding:8px; border:1px solid #444;">Type</th>
                      <th style="padding:8px; border:1px solid #444;">Backups This Week</th>
                      <th style="padding:8px; border:1px solid #444;">Total Backups</th>
                      <th style="padding:8px; border:1px solid #444;">Storage Used</th>
                      <th style="padding:8px; border:1px solid #444;">Retention Policy</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 5px;">
                  <p><strong>Total backups this week:</strong> ${totalCount}</p>
                  <p><strong>Total storage used:</strong> ${(totalSizeBytes / (1024*1024)).toFixed(2)} MB</p>
                  <p><strong>System status:</strong> ‚úÖ Operational</p>
                </div>
              </div>`;
          }

          async function run() {
            if (BACKUP_TYPE === 'weekly-summary') {
              const html = await getWeeklySummary();
              await sendEmail("üìä SimTree Weekly Backup Summary", html);
              return;
            }

            // L√≥gica de Backup normal
            const folderId = BACKUP_TYPE === 'hourly' ? GOOGLE_DRIVE_FOLDER_ID_HOURLY : (BACKUP_TYPE === 'monthly' ? GOOGLE_DRIVE_FOLDER_ID_MONTHLY : GOOGLE_DRIVE_FOLDER_ID_DAILY);
            const fileName = `simtree-${BACKUP_TYPE}-${new Date().getTime()}.sql.gz`;
            const filePath = `/tmp/${fileName}`;
            
            console.log(`>>> Ejecutando dump para ${BACKUP_TYPE}...`);
            let cmd = `/usr/lib/postgresql/17/bin/pg_dump "${DATABASE_URL}" --no-owner --no-acl`;
            if (BACKUP_TYPE === 'hourly') cmd += ` -t wallets -t wallet_transactions -t purchased_esims`;
            
            await execAsync(`${cmd} | gzip -9 > ${filePath}`);
            
            const drive = google.drive({ version: 'v3', auth: getAuth() });
            await drive.files.create({
              requestBody: { name: fileName, parents: [folderId] },
              media: { mimeType: 'application/gzip', body: createReadStream(filePath) },
              supportsAllDrives: true
            });

            console.log(`>>> Backup subido: ${fileName}`);
            if (existsSync(filePath)) unlinkSync(filePath);
          }

          run().catch(async err => {
            console.error(">>> ERROR CR√çTICO:", err);
            await sendEmail(`‚ùå Backup Failed: ${BACKUP_TYPE}`, `<p style="color:red;">Error: ${err.message}</p>`);
            process.exit(1);
          });
          EOF
          node backup.mjs
