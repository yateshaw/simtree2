name: DEBUG - Which Database Am I Using
on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-24.04
    steps:
      - name: Install PostgreSQL client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Check ALL Database Connections
        env:
          PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=================================================="
          echo "üîç CHECKING ALL DATABASE CONNECTIONS"
          echo "=================================================="
          echo ""
          
          echo "1Ô∏è‚É£ PROD_DATABASE_URL:"
          if [ -n "$PROD_DATABASE_URL" ]; then
            echo "  ‚úÖ Secret exists"
            echo "  Host: $(echo "$PROD_DATABASE_URL" | sed -E 's/.*@([^\/]+).*/\1/')"
            psql "$PROD_DATABASE_URL" -c "
              SELECT 
                current_database() AS database,
                pg_size_pretty(pg_database_size(current_database())) AS size,
                (SELECT COUNT(*) FROM esim_plans) AS esim_plans_count
            " 2>&1 || echo "  ‚ùå Connection failed"
          else
            echo "  ‚ùå Secret NOT set"
          fi
          echo ""
          
          echo "2Ô∏è‚É£ DEV_DATABASE_URL:"
          if [ -n "$DEV_DATABASE_URL" ]; then
            echo "  ‚úÖ Secret exists"
            echo "  Host: $(echo "$DEV_DATABASE_URL" | sed -E 's/.*@([^\/]+).*/\1/')"
            psql "$DEV_DATABASE_URL" -c "
              SELECT 
                current_database() AS database,
                pg_size_pretty(pg_database_size(current_database())) AS size,
                (SELECT COUNT(*) FROM esim_plans) AS esim_plans_count
            " 2>&1 || echo "  ‚ùå Connection failed or table doesn't exist"
          else
            echo "  ‚ùå Secret NOT set"
          fi
          echo ""
          
          echo "3Ô∏è‚É£ DATABASE_URL (la vieja?):"
          if [ -n "$DATABASE_URL" ]; then
            echo "  ‚úÖ Secret exists"
            echo "  Host: $(echo "$DATABASE_URL" | sed -E 's/.*@([^\/]+).*/\1/')"
            psql "$DATABASE_URL" -c "
              SELECT 
                current_database() AS database,
                pg_size_pretty(pg_database_size(current_database())) AS size,
                (SELECT COUNT(*) FROM esim_plans) AS esim_plans_count
            " 2>&1 || echo "  ‚ùå Connection failed or table doesn't exist"
          else
            echo "  ‚ùå Secret NOT set"
          fi
          echo ""
          
          echo "=================================================="
          echo "üìä ANALYSIS"
          echo "=================================================="
          echo ""
          echo "La base de datos que DEBER√çA usarse para backups es PROD_DATABASE_URL"
          echo "Si PROD tiene 2000+ filas y los backups solo 130 KB, entonces:"
          echo "  ‚Üí Los workflows NO est√°n usando PROD_DATABASE_URL correctamente"
          echo ""
          echo "Verifica cu√°l tiene tus datos reales (2000+ filas en esim_plans)"
