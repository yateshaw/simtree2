name: DB Backup - Daily (FINAL FIX)
on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
          echo "/usr/lib/postgresql/17/bin" >> $GITHUB_PATH

      # üîß AGREGADO: Instalar dependencias de Node.js
      - name: Install Node.js dependencies
        run: npm install --no-save googleapis

      - name: Run Daily FULL Backup
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID_DAILY }}
        run: |
          cat > backup.mjs << 'EOF'
          import { google } from 'googleapis';
          import { exec } from 'child_process';
          import { createReadStream, unlinkSync, statSync } from 'fs';
          import { promisify } from 'util';
          const execAsync = promisify(exec);

          async function run() {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `simtree-daily-FULL-${timestamp}.sql.gz`;
            const filePath = `/tmp/${fileName}`;

            try {
              console.log('üîÑ Starting full database backup...');
              
              // COMANDO CORREGIDO con --format=plain y --schema=public
              const dumpCommand = `pg_dump "${process.env.DATABASE_URL}" \
                --format=plain \
                --schema=public \
                --no-owner \
                --no-acl \
                --no-privileges \
                --blobs \
                --encoding=UTF8 \
                --verbose \
                --lock-wait-timeout=30000 \
                2>&1`;
              
              console.log('Executing pg_dump...');
              const { stdout, stderr } = await execAsync(`${dumpCommand} | gzip -9 > ${filePath}`);
              
              if (stderr && !stderr.includes('NOTICE')) {
                console.log('pg_dump output:', stderr);
              }

              // Verificar tama√±o del archivo
              const stats = statSync(filePath);
              const sizeKB = (stats.size / 1024).toFixed(2);
              console.log(`üì¶ Backup file size: ${sizeKB} KB`);

              // VALIDACI√ìN: El backup debe ser >500 KB
              if (stats.size < 500000) {
                console.error('‚ö†Ô∏è CRITICAL: Backup file is too small!');
                console.error(`Expected: >500 KB, Got: ${sizeKB} KB`);
                
                // Mostrar contenido para debug
                console.error('Decompressing to check contents...');
                await execAsync(`gunzip -c ${filePath} | head -100`).then(
                  ({ stdout }) => console.error('First 100 lines:', stdout)
                ).catch(e => console.error('Could not decompress:', e.message));
                
                throw new Error(`Backup validation failed: file too small (${sizeKB} KB)`);
              }

              console.log('‚òÅÔ∏è Uploading to Google Drive...');
              const auth = new google.auth.GoogleAuth({
                credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_JSON),
                scopes: ['https://www.googleapis.com/auth/drive']
              });
              
              const drive = google.drive({ version: 'v3', auth });
              
              const response = await drive.files.create({
                requestBody: {
                  name: fileName,
                  parents: [process.env.GOOGLE_DRIVE_FOLDER_ID],
                  description: `Daily full backup - ${timestamp}`
                },
                media: {
                  mimeType: 'application/gzip',
                  body: createReadStream(filePath)
                },
                supportsAllDrives: true
              });

              console.log(`‚úÖ Backup uploaded successfully!`);
              console.log(`üìä File: ${fileName}`);
              console.log(`üìè Size: ${sizeKB} KB`);
              console.log(`üÜî Drive ID: ${response.data.id}`);
              
              unlinkSync(filePath);
            } catch (error) {
              console.error('‚ùå Backup failed:', error.message);
              if (error.stdout) console.error('STDOUT:', error.stdout);
              if (error.stderr) console.error('STDERR:', error.stderr);
              process.exit(1);
            }
          }

          run();
          EOF
          node backup.mjs

      - name: Notify on Failure
        if: failure()
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          NOTIFICATION_EMAIL: ${{ secrets.BACKUP_NOTIFICATION_EMAIL }}
        run: |
          npm install --no-save @sendgrid/mail
          cat > notify.mjs << 'EOF'
          import sgMail from '@sendgrid/mail';
          sgMail.setApiKey(process.env.SENDGRID_API_KEY);
          await sgMail.send({
            to: process.env.NOTIFICATION_EMAIL,
            from: process.env.FROM_EMAIL,
            subject: 'üö® Daily Backup Failed - SimTree',
            text: 'El backup diario fall√≥. Revisa GitHub Actions inmediatamente.',
            html: '<h2>‚ö†Ô∏è Backup Failure Alert</h2><p>El backup diario de SimTree fall√≥.</p><p><strong>Acci√≥n requerida: Revisar logs en GitHub Actions</strong></p>'
          });
          EOF
          node notify.mjs
